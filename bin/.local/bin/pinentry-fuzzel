#!/bin/sh
# shellcheck disable=SC2249

FLAVOR="fuzzel"
VERSION=0.1

DESC=
PROMPT=
ERROR=

PASSWORD_CHAR=''

fmt_desc() {
    case "$ERROR" in
    Bad\ Passphrase*)
        error="${ERROR#Bad\ Passphrase\ (try }"
        error="${error%)}"

        current="${error%\ of*}"
        total="${error#*of }"
        ;;
    esac
    desc="${DESC#"Please enter the passphrase to unlock the OpenPGP secret key:%0A%22"}"
    desc="${desc%\%22*}"
    [ -n "$error" ] && desc="(${error}) ${desc}"
    [ -n "$error" ] && notify-send "GnuPG" "Bad passphrase: ${current} of ${total} tries left"
    echo "$desc"
}

fmt_prompt() {
    [ "$PROMPT" = "Passphrase:" ] && return
    echo "$PROMPT"
}

get_info() { case "$1" in flavor) echo "D $FLAVOR" ;; version) echo "D $VERSION" ;; ttyinfo) echo "D - - -" ;; pid) echo "D $$" ;; esac }
get_pin() { fuzzel --prompt-only='' --placeholder="$(fmt_desc)" --width=50 --cache=/dev/null --password="$PASSWORD_CHAR" --dmenu; }

echo "OK Pleased to meet you"
while IFS=' ' read -r cmd args; do
    case "$cmd" in
    GETINFO)
        echo "D $(get_info "$args")"
        echo "OK"
        ;;
    SETDESC)
        DESC="$args"
        echo "OK"
        ;;
    SETPROMPT)
        PROMPT="$args"
        echo "OK"
        ;;
    SETERROR)
        ERROR="$args"
        echo "OK"
        ;;
    GETPIN)
        echo "D $(get_pin)"
        echo "OK"
        ;;
    BYE)
        echo "OK closing connection"
        exit 0
        ;;
    *)
        echo "OK"
        ;;
    esac
done
