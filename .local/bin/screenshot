#!/bin/sh

set -eu

# shellcheck disable=SC1091
[ -f "${XDG_CONFIG_HOME:-${HOME}/.config}/user-dirs.dirs" ] && . "${XDG_CONFIG_HOME:-${HOME}/.config}/user-dirs.dirs"
OUTPUT_DIRECTORY="${XDG_SCREENSHOTS_DIR:-${XDG_PICTURES_DIR:-${HOME}}}"
FILENAME_DATE_FORMAT="%Y-%m-%d_%H-%M-%S"

SLURP_OPTIONS="-d -b #00000080 -c #ffffff -w 2 -F Terminus"

NOTIFY=0
COPY=0
SAVE=0
WAIT=0

die() {
    echo "${0##*/}: $1" >&2
    exit 1
}

cleanup() {
    [ "${FILE_PATH}" != "-" ] && [ "${SAVE}" -ne 1 ] && rm -f "${FILE_PATH}"
}

notify() {
    notify-send "${0##*/}" "$@"
}

get_file_path() {
    if [ "${SAVE}" -eq 1 ]; then
        echo "${OUTPUT_DIRECTORY}/$(date "+${FILENAME_DATE_FORMAT}").png"
    elif [ "${COPY}" -eq 1 ]; then
        echo "/tmp/${0##*/}-$$.png"
    else
        echo "-"
    fi
}

screenshot_select() {
    # shellcheck disable=SC2086
    geometry=$(slurp ${SLURP_OPTIONS} 2>/dev/null) || die "failed to grab selection"

    grim -g "${geometry}" "${FILE_PATH}"
}

screenshot_full() {
    grim "${FILE_PATH}"
}

while [ "$#" -gt 0 ]; do
    key="$1"

    case "${key}" in
    -n | --notify)
        NOTIFY=1
        shift
        ;;
    -c | --copy)
        COPY=1
        shift
        ;;
    -s | --save)
        SAVE=1
        shift
        ;;
    -w | --wait)
        shift
        WAIT="${1:-}"
        [ -z "${WAIT}" ] && die "no value provided for wait"
        echo "${WAIT}" | grep -q '[^0-9]' && die "invalid value for wait: ${WAIT}"
        shift
        ;;
    *)
        break
        ;;
    esac
done

SCREENSHOT_TYPE="${1:-select}"
FILE_PATH=$(get_file_path)

trap cleanup EXIT

case "${SCREENSHOT_TYPE}" in
select | full)
    [ "${WAIT}" -gt 0 ] && sleep "${WAIT}"
    screenshot_"${SCREENSHOT_TYPE}" || die "failed to take screenshot"
    ;;
*)
    die "invalid screenshot type"
    ;;
esac

if [ "${COPY}" -eq 1 ]; then
    wl-copy --type image/png <"${FILE_PATH}"
fi

if [ "${SAVE}" -eq 1 ]; then
    echo "${FILE_PATH}"
fi

if [ "${NOTIFY}" -eq 1 ]; then
    if [ "${SAVE}" -eq 1 ]; then
        notify "Screenshot saved to <b>${FILE_PATH}</b>."
    elif [ "${COPY}" -eq 1 ]; then
        notify "Screenshot copied."
    else
        notify "Screenshot taken."
    fi
fi
