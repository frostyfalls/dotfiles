#!/bin/sh

set -eu

# shellcheck disable=SC1091
[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs" ] && . "${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs"

OUTPUT_PATH="${XDG_SCREENSHOTS_DIR:-${XDG_PICTURES_DIR:-$HOME}}/$(date "+%Y-%m-%d_%H-%M-%S").png"
NOTIFY_MESSAGE="Saved screenshot."

err() { echo "${0##*/}: $*" >&2; }
notify() { notify-send "Screenshot" "$@"; }

is_valid_mode() { case "$1" in full|select) return 0 ;; *) return 1 ;; esac }

screenshot_full() { grim "$OUTPUT_PATH"; }
screenshot_select() { grim -g "$(slurp)" "$OUTPUT_PATH"; }

COPY=1
MODE="full"

while getopts ':cm:' opt; do
    case "$opt" in
    c)
        COPY=1
        NOTIFY_MESSAGE="Saved screenshot and copied to the clipboard."
        ;;
    m)
        if ! is_valid_mode "$OPTARG"; then
            err "invalid mode: $OPTARG"
            exit 1
        fi
        MODE="$OPTARG"
        ;;
    :)
        err "option -$OPTARG requires an argument"
        exit 1
        ;;
    ?)
        err "invalid option: -$OPTARG"
        exit 1
        ;;
    *) ;;
    esac
done

screenshot_"$MODE"
[ "$COPY" -eq 1 ] && wl-copy -t image/png <"$OUTPUT_PATH"
notify "$NOTIFY_MESSAGE"
