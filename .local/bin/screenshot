#!/bin/sh

set -eu

OUTPUT_DIRECTORY=${XDG_SCREENSHOTS_DIR:-${XDG_PICTURES_DIR:-${HOME}}}
FILENAME_DATE_FORMAT="%Y-%m-%d_%H-%M-%S"

COPY=1
SAVE=1

die() {
    printf '%s' "\
${0##*/}: ${1}
" >&2
    exit 1
}

screenshot_select() {
    file_path=${1}

    region=$(slurp 2>/dev/null) || return 1
    grim -g "${region}" "${file_path}"
}

screenshot_full() {
    file_path=${1}

    grim "${file_path}"
}

screenshot_type=${1}

case ${screenshot_type} in
    select | full) ;;
    *) die "invalid screenshot type" ;;
esac

if [ "${SAVE}" -eq 1 ]; then
    FILE_PATH="${OUTPUT_DIRECTORY}/$(date "+${FILENAME_DATE_FORMAT}").png"
else
    FILE_PATH="/tmp/${0##*/}-$(date '+%s').png"
fi

screenshot_"${screenshot_type}" "${FILE_PATH}" || die "failed"

[ "${COPY}" -eq 1 ] && [ "${SAVE}" -eq 1 ] && wl-copy --type image/png "${FILE_PATH}"
[ "${COPY}" -eq 1 ] && [ "${SAVE}" -ne 1 ] && wl-copy --type image/png <"${FILE_PATH}"

[ "${SAVE}" -ne 1 ] && rm -f "${FILE_PATH}"

[ "${SAVE}" -eq 1 ] && printf '%s\n' "${FILE_PATH}"
