#!/bin/sh

set -eu

[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs" ] && . "${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs"

WALLPAPERS_PATH="${XDG_WALLPAPERS_DIR:-${XDG_PICTURES_DIR:-$HOME/Pictures}}"
DESTINATION_PATH="${XDG_DATA_HOME:-$HOME/.local/share}/wallpaper"

alias notify='notify-send "Wallpaper"'
alias prompt='fuzzel -d -p "wallpaper "'
alias viewer='nsxiv -ot'

paths="$(find "$WALLPAPERS_PATH" -type f | while IFS= read -r line; do
    printf '%s\n' "${line#"$WALLPAPERS_PATH"/}"
done | shuf)"
selection="$(printf 'Image Viewer\n\n%s' "$paths" | prompt)"
if [ "$selection" = "Image Viewer" ]; then
    sel_path="$(viewer "$WALLPAPERS_PATH")"
    selection="$(printf '%s' "${sel_path#"$WALLPAPERS_PATH"/}")"
fi
[ -z "$selection" ] && return
cp "$WALLPAPERS_PATH/$selection" "$DESTINATION_PATH" && notify "Set <b>$selection</b> as the wallpaper."
