#!/bin/sh

set -eu

PREFIX="${PASSWORD_STORE_DIR:-$HOME/.password-store}"
SUFFIX=
TOTP=0

create_entries_list() {
    { if [ "$TOTP" -eq 1 ]; then
        find "$PREFIX/$SUFFIX" -type f -name '*.gpg'
    else
        find "$PREFIX" -type f -name '*.gpg' -not -path '*TOTP*'
    fi; } | while IFS= read -r file; do
        password="${file#"$PREFIX"/}"
        [ -n "$SUFFIX" ] && password="${password#"$SUFFIX"/}"
        password="${password%.gpg}"
        echo "$password"
    done | sort -f
}

prompt_user_selection() { dmenu -l 16 -c -bw 1; }

while [ "$#" -gt 0 ]; do
    case "${1:-}" in
    -o | --totp)
        TOTP=1
        SUFFIX="TOTP"
        shift
        ;;
    *)
        break
        ;;
    esac
done

entry=$(create_entries_list | prompt_user_selection)
[ -z "$entry" ] && exit

if [ "$TOTP" -eq 1 ]; then
    pass otp -c "$SUFFIX/$entry" 2>/dev/null
else
    pass show -c "$entry" 2>/dev/null
fi
