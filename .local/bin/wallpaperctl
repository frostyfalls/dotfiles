#!/bin/sh

set -eu

OUTPUT_FILE="${XDG_DATA_HOME:-${HOME}/.local/share}/wallpaper"
WALLPAPER_MODE="fill"

die() {
    echo "${0##*/}: $1" >&2
    exit 1
}

verify_image_path() {
    [ ! -f "$1" ] && die "no such file"
    case "$1" in
    /*) ;;
    *) die "path must be absolute" ;;
    esac
    case "${1##*.}" in
    png | jpg | jpeg) ;;
    *) die "unsupported file type" ;;
    esac
}

run_wallpaper() {
    pkill swaybg || :
    swaybg --image "${OUTPUT_FILE}" --mode "${WALLPAPER_MODE}"
}

set_wallpaper() {
    source_image="$1"
    verify_image_path "${source_image}"

    relative_image_path=$(realpath --relative-to="${OUTPUT_FILE%/*}" "${source_image}") ||
        die "failed to determine relative image path"
    mkdir -p "${OUTPUT_FILE%/*}"
    ln -sf "${relative_image_path}" "${OUTPUT_FILE}"

    run_wallpaper
}

restore_wallpaper() {
    [ ! -f "${OUTPUT_FILE}" ] && die "output file not found"

    run_wallpaper
}

case "${1:-}" in
set) set_wallpaper "$2" ;;
restore) restore_wallpaper ;;
*) exit 1 ;;
esac
